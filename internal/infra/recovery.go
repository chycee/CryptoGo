package infra

import (
	"log/slog"
	"os"
	"runtime/debug"
)

// Recoverλ” ν¨λ‹‰μΌλ΅λ¶€ν„° λ³µκµ¬ν•κ³ , μ¤νƒ νΈλ μ΄μ¤λ¥Ό λ΅κΉ…ν• λ’¤ μΆ…λ£ν•©λ‹λ‹¤.
// μ΄ ν•¨μλ” λ©”μΈ μ—”νΈλ¦¬ ν¬μΈνΈλ‚ μ¤‘μ”ν• κ³ λ£¨ν‹΄μ μµμƒλ‹¨μ—μ„ deferλ΅ νΈμ¶λμ–΄μ•Ό ν•©λ‹λ‹¤.
func Recover() {
	if r := recover(); r != nil {
		// 1. μ¤νƒ νΈλ μ΄μ¤ μΊ΅μ²
		stack := string(debug.Stack())

		// 2. μ¤νƒκ³Ό ν•¨κ» μ‹¬κ°ν• μ—λ¬ λ΅κΉ…
		// κµ¬μ΅°ν™”λ λ΅κΉ…μ„ μ‚¬μ©ν•μ—¬ νμ‹± κ°€λ¥ν•κ² ν•¨.
		slog.Error("π¨ CRITICAL PANIC RECOVERED",
			"error", r,
			"stack", stack,
		)

		// 3. μΆ…λ£
		// Sequencer μ•„ν‚¤ν…μ²μ—μ„ ν•«ν¨μ¤(hotpath) λ‚΄μ ν¨λ‹‰μ€ λ―Έμ •μ μƒνƒλ¥Ό μλ―Έν•¨.
		// λ°μ΄ν„° μ¤μ—Όμ„ λ°©μ§€ν•κΈ° μ„ν•΄ λ°λ“μ‹ ν¬λμ‹(μΆ…λ£)ν•΄μ•Ό ν•¨.
		os.Exit(1)
	}
}
